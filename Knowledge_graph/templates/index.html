<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>知识图谱可视化</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #2d3748;
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        .controls {
            background: white;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #3182ce;
        }

        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #718096;
        }

        .btn-secondary:hover {
            background: #4a5568;
        }

        select {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            background: #38a169;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .file-input-label:hover {
            background: #2f855a;
        }

        .main-container {
            flex: 1;
            display: flex;
            background: white;
            position: relative;
        }

        .sidebar {
            width: 300px;
            background: #f7fafc;
            border-right: 1px solid #e2e8f0;
            padding: 1rem;
            overflow-y: auto;
        }

        .sidebar h3 {
            margin-bottom: 1rem;
            color: #2d3748;
        }

        .node-info, .edge-info {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .info-title {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .info-item {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .info-label {
            font-weight: 500;
            color: #4a5568;
        }

        .info-value {
            color: #718096;
        }

        .graph-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #graph {
            width: 100%;
            height: 100%;
            background: #ffffff;
        }

        .node {
            cursor: pointer;
            stroke-width: 2;
        }

        .node:hover {
            stroke-width: 3;
        }

        .link {
            stroke: #999;
            stroke-opacity: 0.6;
            stroke-width: 1.5;
            fill: none;
            marker-end: url(#arrowhead);
        }

        .node-label {
            font-size: 12px;
            fill: #333;
            text-anchor: middle;
            pointer-events: none;
            font-weight: 500;
        }

        .link-label {
            font-size: 10px;
            fill: #666;
            text-anchor: middle;
            pointer-events: none;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.5rem;
            border-radius: 4px;
            pointer-events: none;
            font-size: 0.8rem;
            z-index: 1000;
            max-width: 200px;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            color: #4a5568;
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem;
        }

        .warning-message {
            background: #fef5e7;
            color: #c05621;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem;
            border-left: 4px solid #ed8936;
        }

        .stats {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .zoom-btn:hover {
            background: #f7fafc;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>知识图谱可视化</h1>
    </div>

    <div class="controls">
        <div class="control-group">
            <label for="presetSelect">预设文件:</label>
            <select id="presetSelect">
                <option value="">选择预设文件...</option>
            </select>
            <button class="btn" id="loadPresetBtn">加载</button>
        </div>
        
        <div class="control-group">
            <input type="file" id="fileInput" class="file-input" accept=".json">
            <label for="fileInput" class="file-input-label">上传JSON文件</label>
        </div>

        <div class="control-group">
            <button class="btn btn-secondary" id="resetBtn">重置视图</button>
            <button class="btn btn-secondary" id="clearBtn">清空图谱</button>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="stats" id="stats">
                <h3>图谱统计</h3>
                <div class="stats-item">
                    <span>节点数量:</span>
                    <span id="nodeCount">0</span>
                </div>
                <div class="stats-item">
                    <span>关系数量:</span>
                    <span id="edgeCount">0</span>
                </div>
            </div>
            
            <div id="selectedInfo">
                <h3>选中信息</h3>
                <div id="infoContent">
                    <p style="color: #718096; font-style: italic;">点击节点或关系查看详细信息</p>
                </div>
            </div>
        </div>

        <div class="graph-container">
            <svg id="graph"></svg>
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoomInBtn">+</button>
                <button class="zoom-btn" id="zoomOutBtn">-</button>
                <button class="zoom-btn" id="fitBtn">⊡</button>
            </div>
            <div class="tooltip" id="tooltip" style="display: none;"></div>
            <div class="loading" id="loading" style="display: none;">加载中...</div>
        </div>
    </div>

    <script>
        class KnowledgeGraph {
            constructor() {
                this.svg = d3.select('#graph');
                this.tooltip = d3.select('#tooltip');
                this.width = 0;
                this.height = 0;
                this.simulation = null;
                this.zoom = null;
                this.g = null;
                this.data = { nodes: [], relationships: [] };
                
                this.init();
                this.loadPresetFiles();
            }

            init() {
                // 设置SVG尺寸
                this.updateSize();
                window.addEventListener('resize', () => this.updateSize());

                // 创建缩放行为
                this.zoom = d3.zoom()
                    .scaleExtent([0.1, 10])
                    .on('zoom', (event) => {
                        this.g.attr('transform', event.transform);
                    });

                this.svg.call(this.zoom);

                // 创建主容器组
                this.g = this.svg.append('g');

                // 创建箭头标记
                this.svg.append('defs').append('marker')
                    .attr('id', 'arrowhead')
                    .attr('viewBox', '0 -5 10 10')
                    .attr('refX', 25)
                    .attr('refY', 0)
                    .attr('markerWidth', 6)
                    .attr('markerHeight', 6)
                    .attr('orient', 'auto')
                    .append('path')
                    .attr('d', 'M0,-5L10,0L0,5')
                    .attr('fill', '#999');

                // 事件监听
                this.setupEventListeners();
            }

            updateSize() {
                const container = document.querySelector('.graph-container');
                const rect = container.getBoundingClientRect();
                this.width = rect.width;
                this.height = rect.height;
                this.svg.attr('width', this.width).attr('height', this.height);
            }

            setupEventListeners() {
                // 预设文件加载
                document.getElementById('loadPresetBtn').addEventListener('click', () => {
                    this.loadPresetFile();
                });

                // 文件上传
                document.getElementById('fileInput').addEventListener('change', (e) => {
                    this.handleFileUpload(e.target.files[0]);
                });

                // 控制按钮
                document.getElementById('resetBtn').addEventListener('click', () => {
                    this.resetView();
                });

                document.getElementById('clearBtn').addEventListener('click', () => {
                    this.clearGraph();
                });

                // 缩放控制
                document.getElementById('zoomInBtn').addEventListener('click', () => {
                    this.svg.transition().call(this.zoom.scaleBy, 1.5);
                });

                document.getElementById('zoomOutBtn').addEventListener('click', () => {
                    this.svg.transition().call(this.zoom.scaleBy, 1 / 1.5);
                });

                document.getElementById('fitBtn').addEventListener('click', () => {
                    this.fitToScreen();
                });
            }

            async loadPresetFiles() {
                try {
                    const response = await fetch('/api/preset-files');
                    const result = await response.json();
                    
                    if (result.success) {
                        const select = document.getElementById('presetSelect');
                        select.innerHTML = '<option value="">选择预设文件...</option>';
                        
                        result.files.forEach(file => {
                            const option = document.createElement('option');
                            option.value = file.path;
                            option.textContent = file.name;
                            select.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('加载预设文件列表失败:', error);
                }
            }

            async loadPresetFile() {
                const select = document.getElementById('presetSelect');
                const filename = select.value;
                
                if (!filename) {
                    alert('请选择一个预设文件');
                    return;
                }

                this.showLoading(true);
                
                try {
                    const response = await fetch(`/api/load-preset/${filename}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        this.loadData(result.data);
                    } else {
                        this.showError(result.error);
                    }
                } catch (error) {
                    this.showError('加载文件失败: ' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }

            async handleFileUpload(file) {
                if (!file) return;

                this.showLoading(true);
                
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        this.loadData(result.data);
                    } else {
                        this.showError(result.error);
                    }
                } catch (error) {
                    this.showError('上传文件失败: ' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }

            loadData(data) {
                this.data = this.processAndValidateData(data);
                this.renderGraph();
                this.updateStats();
            }

            processAndValidateData(data) {
                // 保存原始数据用于统计
                this.originalData = JSON.parse(JSON.stringify(data));
                
                // 创建节点ID集合用于快速查找
                const nodeIdSet = new Set(data.nodes.map(node => node.id));
                const missingNodeIds = new Set();
                
                // 检查关系中引用的节点是否存在
                const validRelationships = [];
                const invalidRelationships = [];
                
                data.relationships.forEach(rel => {
                    const sourceId = typeof rel.source === 'object' ? rel.source.id : rel.source;
                    const targetId = typeof rel.target === 'object' ? rel.target.id : rel.target;
                    
                    const sourceExists = nodeIdSet.has(sourceId);
                    const targetExists = nodeIdSet.has(targetId);
                    
                    if (sourceExists && targetExists) {
                        validRelationships.push(rel);
                    } else {
                        invalidRelationships.push(rel);
                        if (!sourceExists) missingNodeIds.add(sourceId);
                        if (!targetExists) missingNodeIds.add(targetId);
                    }
                });
                
                // 如果有缺失的节点，显示警告信息
                if (missingNodeIds.size > 0) {
                    const missingIds = Array.from(missingNodeIds);
                    console.warn('发现缺失的节点:', missingIds);
                    this.showWarning(`发现 ${invalidRelationships.length} 个关系引用了不存在的节点。缺失的节点ID: ${missingIds.slice(0, 5).join(', ')}${missingIds.length > 5 ? '...' : ''}`);
                }
                
                return {
                    nodes: data.nodes,
                    relationships: validRelationships
                };
            }

            renderGraph() {
                // 清除现有内容
                this.g.selectAll('*').remove();

                const nodes = this.data.nodes.map(d => ({ ...d }));
                const links = this.data.relationships.map(d => ({ ...d }));

                // 创建力导向仿真
                this.simulation = d3.forceSimulation(nodes)
                    .force('link', d3.forceLink(links).id(d => d.id).distance(80))
                    .force('charge', d3.forceManyBody().strength(-300))
                    .force('center', d3.forceCenter(this.width / 2, this.height / 2))
                    .force('collision', d3.forceCollide().radius(30));

                // 创建链接
                const link = this.g.append('g')
                    .selectAll('.link')
                    .data(links)
                    .join('line')
                    .attr('class', 'link')
                    .on('click', (event, d) => this.selectRelationship(d));

                // 创建链接标签
                const linkLabel = this.g.append('g')
                    .selectAll('.link-label')
                    .data(links)
                    .join('text')
                    .attr('class', 'link-label')
                    .text(d => d.type);

                // 节点颜色函数
                const color = d3.scaleOrdinal(d3.schemeCategory10);

                // 创建节点
                const node = this.g.append('g')
                    .selectAll('.node')
                    .data(nodes)
                    .join('circle')
                    .attr('class', 'node')
                    .attr('r', 20)
                    .attr('fill', d => color(d.label ? d.label[0] : 'default'))
                    .attr('stroke', '#fff')
                    .call(this.drag())
                    .on('click', (event, d) => this.selectNode(d))
                    .on('mouseover', (event, d) => this.showTooltip(event, d))
                    .on('mouseout', () => this.hideTooltip());

                // 创建节点标签
                const nodeLabel = this.g.append('g')
                    .selectAll('.node-label')
                    .data(nodes)
                    .join('text')
                    .attr('class', 'node-label')
                    .text(d => d.properties?.name || d.properties?.value || d.label || d.id.substring(0, 8) + '...');

                // 更新仿真
                this.simulation.on('tick', () => {
                    link
                        .attr('x1', d => d.source.x)
                        .attr('y1', d => d.source.y)
                        .attr('x2', d => d.target.x)
                        .attr('y2', d => d.target.y);

                    linkLabel
                        .attr('x', d => (d.source.x + d.target.x) / 2)
                        .attr('y', d => (d.source.y + d.target.y) / 2);

                    node
                        .attr('cx', d => d.x)
                        .attr('cy', d => d.y);

                    nodeLabel
                        .attr('x', d => d.x)
                        .attr('y', d => d.y + 35);
                });
            }

            drag() {
                return d3.drag()
                    .on('start', (event, d) => {
                        if (!event.active) this.simulation.alphaTarget(0.3).restart();
                        d.fx = d.x;
                        d.fy = d.y;
                    })
                    .on('drag', (event, d) => {
                        d.fx = event.x;
                        d.fy = event.y;
                    })
                    .on('end', (event, d) => {
                        if (!event.active) this.simulation.alphaTarget(0);
                        d.fx = null;
                        d.fy = null;
                    });
            }

            selectNode(node) {
                const content = document.getElementById('infoContent');
                let html = '<div class="node-info">';
                html += `<div class="info-title">节点信息</div>`;
                html += `<div class="info-item"><span class="info-label">ID:</span> <span class="info-value">${node.id}</span></div>`;
                
                if (node.label) {
                    html += `<div class="info-item"><span class="info-label">标签:</span> <span class="info-value">${node.label.join(', ')}</span></div>`;
                }
                
                if (node.properties) {
                    html += `<div class="info-item"><span class="info-label">属性:</span></div>`;
                    for (const [key, value] of Object.entries(node.properties)) {
                        html += `<div class="info-item" style="margin-left: 1rem;"><span class="info-label">${key}:</span> <span class="info-value">${value}</span></div>`;
                    }
                }
                
                html += '</div>';
                content.innerHTML = html;
            }

            selectRelationship(relationship) {
                const content = document.getElementById('infoContent');
                let html = '<div class="edge-info">';
                html += `<div class="info-title">关系信息</div>`;
                html += `<div class="info-item"><span class="info-label">类型:</span> <span class="info-value">${relationship.type}</span></div>`;
                html += `<div class="info-item"><span class="info-label">源节点:</span> <span class="info-value">${relationship.source.id || relationship.source}</span></div>`;
                html += `<div class="info-item"><span class="info-label">目标节点:</span> <span class="info-value">${relationship.target.id || relationship.target}</span></div>`;
                
                if (relationship.properties) {
                    html += `<div class="info-item"><span class="info-label">属性:</span></div>`;
                    for (const [key, value] of Object.entries(relationship.properties)) {
                        html += `<div class="info-item" style="margin-left: 1rem;"><span class="info-label">${key}:</span> <span class="info-value">${value}</span></div>`;
                    }
                }
                
                html += '</div>';
                content.innerHTML = html;
            }

            showTooltip(event, node) {
                let content = `<strong>${node.properties?.name || node.id}</strong><br>`;
                if (node.label) {
                    content += `标签: ${node.label.join(', ')}<br>`;
                }
                if (node.properties?.time) {
                    content += `时间: ${node.properties.time}`;
                }

                this.tooltip
                    .style('display', 'block')
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 10) + 'px')
                    .html(content);
            }

            hideTooltip() {
                this.tooltip.style('display', 'none');
            }

            updateStats() {
                const totalNodes = this.data.nodes.length;
                const totalRelationships = this.data.relationships.length;
                const originalRelationships = this.originalData ? this.originalData.relationships.length : totalRelationships;
                
                document.getElementById('nodeCount').textContent = totalNodes;
                document.getElementById('edgeCount').textContent = totalRelationships;
                
                // 如果有被过滤的关系，显示额外信息
                if (originalRelationships > totalRelationships) {
                    const filteredCount = originalRelationships - totalRelationships;
                    const edgeCountElement = document.getElementById('edgeCount');
                    edgeCountElement.innerHTML = `${totalRelationships} <small style="color: #e53e3e;">(${filteredCount} 个无效)</small>`;
                }
            }

            resetView() {
                const transform = d3.zoomIdentity;
                this.svg.transition().call(this.zoom.transform, transform);
            }

            fitToScreen() {
                if (this.data.nodes.length === 0) return;

                const bounds = this.g.node().getBBox();
                const fullWidth = this.width;
                const fullHeight = this.height;
                const width = bounds.width;
                const height = bounds.height;
                const midX = bounds.x + width / 2;
                const midY = bounds.y + height / 2;

                if (width === 0 || height === 0) return;

                const scale = Math.min(fullWidth / width, fullHeight / height) * 0.8;
                const translate = [fullWidth / 2 - scale * midX, fullHeight / 2 - scale * midY];

                this.svg.transition()
                    .call(this.zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
            }

            clearGraph() {
                this.data = { nodes: [], relationships: [] };
                this.g.selectAll('*').remove();
                this.updateStats();
                document.getElementById('infoContent').innerHTML = '<p style="color: #718096; font-style: italic;">点击节点或关系查看详细信息</p>';
            }

            showLoading(show) {
                document.getElementById('loading').style.display = show ? 'block' : 'none';
            }

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = message;
                document.body.appendChild(errorDiv);
                
                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            }

            showWarning(message) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'warning-message';
                warningDiv.textContent = message;
                document.body.appendChild(warningDiv);
                
                setTimeout(() => {
                    warningDiv.remove();
                }, 8000);
            }
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            new KnowledgeGraph();
        });
    </script>
</body>
</html>